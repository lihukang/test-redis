<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.nhncorp.ooms.redis.deptIncome.dao.DeptIncomeDao">

    <select id="selectOrgWrkAcmpActivityByOrderList" parameterType="map" resultType="com.nhncorp.ooms.redis.deptIncome.model.DeptIncomeModel">
		/*selectOrgWrkAcmpActivityByOrderList*/
		SELECT /*+ USE_IDX */
		TASK.ORDER_JOB_NO
		, TASK.TASK_NO AS TASK_NO
		, SUB.SUB_TASK_SEQ AS SUB_TASK_SEQ
		, '(A)'||SUB.SUB_TASK_NM AS TASK_NM
		, SUB.UPR_SUB_TASK_SEQ AS UPR_SUB_TASK_SEQ
		, SUB.TASK_LEVEL AS TASK_LEVEL
			,ORG.ORG_NM || '/' || (SELECT USER_NM FROM O2_USER WHERE USER_ID = ACMP.USER_ID)  AS USER_NM
         	,ACMP.USER_ID
			,CAST( SUM(DECODE( ACMP.ACMP_YMD,#{startYmd}, ACMP.INPRSC_TM, 0 )) AS
			BIGINT ) / 60 AS TM_DATA
			,SUM(DECODE( ACMP.ACMP_YMD,#{startYmd}, ACMP.TRT_CCNT, 0 )) AS CNT_DATA
			,#{startYmd} ymd
			,USER_ORG_ID
		FROM O2_TASK TASK
		INNER JOIN O2_SUB_TASK SUB
		ON TASK.TASK_NO= SUB.TASK_NO
		LEFT OUTER JOIN (
		SELECT ODA.ACMP_YMD
		,OWAD.TASK_NO
		,SUB.SUB_TASK_SEQ
		,OWAD.INPRSC_TM AS INPRSC_TM
		,OWAD.TRT_CCNT AS TRT_CCNT
		,ODA.USER_ID
		, ODA.USER_ORG_ID
		FROM O2_DDBY_ACMP ODA
		INNER JOIN O2_WRK_ACMP_DTL OWAD
		ON ODA.DDBY_ACMP_SEQ = OWAD.DDBY_ACMP_SEQ
		AND OWAD.AGRN_MTHD_TP_CD = 'CFM'
		INNER JOIN O2_SUB_TASK SUB
		ON OWAD.SUB_TASK_SEQ = SUB.SUB_TASK_SEQ
		WHERE SUB.TASK_LEVEL = '3'
		<if test="orgId !=null and orgId !=''">  
		AND ODA.USER_ORG_ID = #{orgId}
		</if>
		AND ODA.CLS_STAT_CD IN ('ADCMPL','ATMTAD','TMPAD')
		AND ( OWAD.INPRSC_TM > 0 OR OWAD.TRT_CCNT > 0 )
		AND ODA.ACMP_YMD BETWEEN REPLACE(#{startYmd},'-','') AND
		REPLACE(#{startYmd},'-','')

		UNION ALL

		SELECT ODA.ACMP_YMD
		,OUWAD.TASK_NO
		,SUB.SUB_TASK_SEQ
		,OUWAD.INPRSC_TM AS INPRSC_TM
		,OUWAD.TRT_CCNT AS TRT_CCNT
		,ODA.USER_ID
		, ODA.USER_ORG_ID

		FROM (
		SELECT ODA.ACMP_YMD
		,ODA.DDBY_ACMP_SEQ
		,ODA.USER_ID
		,ODA.USER_ORG_ID
		FROM O2_DDBY_ACMP ODA
		WHERE ODA.cls_stat_cd IN ('ADWAIT','RJCT')
		<if test="orgId !=null and orgId !=''">  
		AND ODA.USER_ORG_ID = #{orgId}
		</if>
		AND ODA.ACMP_YMD BETWEEN REPLACE(#{startYmd},'-','') AND
		REPLACE(#{startYmd},'-','') ) ODA
		INNER JOIN O2_ACMP_ADMS_REQ OAAR
		ON ODA.DDBY_ACMP_SEQ = OAAR.DDBY_ACMP_SEQ
		INNER JOIN o2_unadms_wrk_acmp_dtl OUWAD
		ON OAAR.ADMS_REQ_SEQ = OUWAD.ADMS_REQ_SEQ
		INNER JOIN O2_SUB_TASK SUB
		ON OUWAD.SUB_TASK_SEQ = SUB.SUB_TASK_SEQ
		WHERE OAAR.LAST_YN='Y'
		AND SUB.TASK_LEVEL = '3'
		AND ( OUWAD.INPRSC_TM > 0 OR OUWAD.TRT_CCNT > 0 )
		) ACMP
		ON SUB.SUB_TASK_SEQ = ACMP.SUB_TASK_SEQ
			INNER JOIN
			O2_ORG ORG
			ON ORG.ORG_ID = ACMP.USER_ORG_ID
			<if test="orgId !=null and orgId !=''">  
			AND ORG.ORG_ID = #{orgId}
			</if>
		AND SUB.TASK_LEVEL = 3
		GROUP BY
			ORG.ORG_NM,
			ACMP.USER_ID,
		TASK.ORDER_JOB_NO,
		TASK.TASK_NO,
		SUB.SUB_TASK_SEQ DESC,
		'(A)'||SUB.SUB_TASK_NM,
		SUB.UPR_SUB_TASK_SEQ,
		SUB.TASK_LEVEL

	</select>
	
	<select id="selectOrgWrkAcmpSubTaskByOrderList" parameterType="map" resultType="com.nhncorp.ooms.redis.deptIncome.model.DeptIncomeModel">
		/*selectOrgWrkAcmpSubTaskByOrderList*/
		SELECT /*+ USE_IDX */
		TASK.ORDER_JOB_NO
		, TASK.TASK_NO AS TASK_NO
		, SUB.SUB_TASK_SEQ AS SUB_TASK_SEQ
		, '(S)'||SUB.SUB_TASK_NM AS TASK_NM
		, SUB.UPR_SUB_TASK_SEQ AS UPR_SUB_TASK_SEQ
		, SUB.TASK_LEVEL AS TASK_LEVEL
			,ORG.ORG_NM || '/' || (SELECT USER_NM FROM O2_USER WHERE USER_ID = ACMP.USER_ID)  AS USER_NM
 			,ACMP.USER_ID
			,CAST( SUM(DECODE( ACMP.ACMP_YMD,#{startYmd}, ACMP.INPRSC_TM, 0 )) AS
			BIGINT ) / 60 AS TM_DATA
			,SUM(DECODE( ACMP.ACMP_YMD,#{startYmd}, ACMP.TRT_CCNT, 0 )) AS CNT_DATA
			,#{startYmd} ymd
			,USER_ORG_ID
		FROM O2_TASK TASK
		INNER JOIN O2_SUB_TASK SUB
		ON TASK.TASK_NO= SUB.TASK_NO
		LEFT OUTER JOIN (
		SELECT A.ACMP_YMD
		,A.TASK_NO
		,A.SUB_TASK_SEQ
		,A.INPRSC_TM
		,A.TRT_CCNT
		,A.USER_ID
		,A.USER_ORG_ID
		FROM (
		SELECT ODA.ACMP_YMD
		,OWAD.TASK_NO
		,DECODE(SUB.TASK_LEVEL, '2',SUB.SUB_TASK_SEQ,'3',SUB.UPR_SUB_TASK_SEQ) SUB_TASK_SEQ
		,OWAD.INPRSC_TM
		,OWAD.TRT_CCNT
		,ODA.USER_ID
		, ODA.USER_ORG_ID
		FROM O2_DDBY_ACMP ODA
		INNER JOIN O2_WRK_ACMP_DTL OWAD
		ON ODA.DDBY_ACMP_SEQ = OWAD.DDBY_ACMP_SEQ
		AND OWAD.AGRN_MTHD_TP_CD = 'CFM'
		INNER JOIN O2_SUB_TASK SUB
		ON OWAD.SUB_TASK_SEQ = SUB.SUB_TASK_SEQ
		WHERE SUB.TASK_LEVEL IN ('2' ,'3')
		<if test="orgId !=null and orgId !=''">  
		AND ODA.USER_ORG_ID = #{orgId}
		</if>
		AND ODA.CLS_STAT_CD IN ('ADCMPL','ATMTAD','TMPAD')
		AND ( OWAD.INPRSC_TM > 0 OR OWAD.TRT_CCNT > 0 )
		AND ODA.ACMP_YMD BETWEEN REPLACE(#{startYmd},'-','') AND
		REPLACE(#{startYmd},'-','')
		) A

		UNION ALL

		SELECT ODA.ACMP_YMD
		,OUWAD.TASK_NO
		,DECODE(SUB.TASK_LEVEL,'2',SUB.SUB_TASK_SEQ,'3', SUB.UPR_SUB_TASK_SEQ) AS SUB_TASK_SEQ
		,OUWAD.INPRSC_TM AS INPRSC_TM
		,OUWAD.TRT_CCNT AS TRT_CCNT
		,ODA.USER_ID
		, ODA.USER_ORG_ID
		FROM (
		SELECT ODA.ACMP_YMD
		,ODA.DDBY_ACMP_SEQ
		,ODA.USER_ID
		, ODA.USER_ORG_ID
		FROM O2_DDBY_ACMP ODA
		WHERE ODA.cls_stat_cd IN ('ADWAIT','RJCT')
		<if test="orgId !=null and orgId !=''">  
		AND ODA.USER_ORG_ID = #{orgId}
		</if>
		AND ODA.ACMP_YMD BETWEEN REPLACE(#{startYmd},'-','') AND
		REPLACE(#{startYmd},'-','') ) ODA
		INNER JOIN O2_ACMP_ADMS_REQ OAAR
		ON ODA.DDBY_ACMP_SEQ = OAAR.DDBY_ACMP_SEQ
		INNER JOIN o2_unadms_wrk_acmp_dtl OUWAD
		ON OAAR.ADMS_REQ_SEQ = OUWAD.ADMS_REQ_SEQ
		INNER JOIN O2_SUB_TASK SUB
		ON OUWAD.SUB_TASK_SEQ = SUB.SUB_TASK_SEQ
		WHERE OAAR.LAST_YN='Y'
		AND SUB.TASK_LEVEL IN ('2','3')
		) ACMP
		ON SUB.SUB_TASK_SEQ = ACMP.SUB_TASK_SEQ
			INNER JOIN
			O2_ORG ORG
			ON ORG.ORG_ID = ACMP.USER_ORG_ID
			<if test="orgId !=null and orgId !=''">  
			AND ORG.ORG_ID = #{orgId}
			</if>
		AND SUB.TASK_LEVEL = 2
		GROUP BY
			ORG.ORG_NM,
			ACMP.USER_ID,
		TASK.ORDER_JOB_NO,
		TASK.TASK_NO ,
		SUB.SUB_TASK_SEQ DESC,
		'(S)'||SUB.SUB_TASK_NM,
		SUB.UPR_SUB_TASK_SEQ,
		SUB.TASK_LEVEL

	</select>
	
	
	<select id="selectOrgWrkAcmpTaskByOrderList" parameterType="map" resultType="com.nhncorp.ooms.redis.deptIncome.model.DeptIncomeModel">
		/*selectOrgWrkAcmpTaskByOrderList*/
		SELECT /*+ USE_IDX */
		A.ORDER_JOB_NO
		, A.TASK_NO AS TASK_NO
		, A.SUB_TASK_SEQ AS SUB_TASK_SEQ
		, CASE WHEN A.TASK_STAT_CD = 'END' THEN
		(SELECT
		'(T)('||COMM.COMM_CD_NM||')['||ESM.ESM_NM||'] '||A.TASK_NM
		FROM O2_COMM_CD COMM WHERE COMM.COMM_GRP_CD = 'TSKST' AND COMM.USE_YN =
		'Y' AND COMM.LANG_CD ='ko_KR' AND COMM.COMM_CD = 'END')
		ELSE
		'(T)['||ESM.ESM_NM||'] '||A.TASK_NM
		END AS TASK_NM
		, A.ORDER_JOB_NO AS UPR_SUB_TASK_SEQ
		, A.TASK_LEVEL AS TASK_LEVEL
			,A.USER_NM
			,A.USER_ID
			,CAST( SUM(DECODE( A.ACMP_YMD,#{startYmd}, A.INPRSC_TM, 0 )) AS BIGINT ) /
			60 AS TM_DATA
			,SUM(DECODE( A.ACMP_YMD,#{startYmd}, A.TRT_CCNT, 0 )) AS CNT_DATA
			,#{startYmd} ymd
			,USER_ORG_ID
		FROM (
		SELECT /*+ USE_IDX */
		TASK.ORDER_JOB_NO
		,TASK.TASK_STAT_CD
		, TASK.TASK_NO AS TASK_NO
		, SUB.SUB_TASK_SEQ AS SUB_TASK_SEQ
		, TASK.TASK_NM AS TASK_NM
		, TASK.ORDER_JOB_NO AS UPR_SUB_TASK_SEQ
		, SUB.TASK_LEVEL AS TASK_LEVEL
		 ,ORG.ORG_NM || '/' || (SELECT USER_NM FROM O2_USER WHERE USER_ID = ACMP.USER_ID)  AS USER_NM
         ,ACMP.USER_ID
		,ACMP.ACMP_YMD
		,ACMP.INPRSC_TM
		,ACMP.TRT_CCNT
		,TASK.ESM_CD
		,USER_ORG_ID
		FROM O2_TASK TASK
		INNER JOIN O2_SUB_TASK SUB
		ON TASK.TASK_NO= SUB.TASK_NO
		LEFT OUTER JOIN (
		SELECT ODA.ACMP_YMD
		,OWAD.TASK_NO
		,OWAD.INPRSC_TM AS INPRSC_TM
		,OWAD.TRT_CCNT AS TRT_CCNT
		,ODA.USER_ID
		, ODA.USER_ORG_ID
		FROM O2_DDBY_ACMP ODA
		INNER JOIN O2_WRK_ACMP_DTL OWAD
		ON ODA.DDBY_ACMP_SEQ = OWAD.DDBY_ACMP_SEQ
		AND OWAD.AGRN_MTHD_TP_CD = 'CFM'
		WHERE ODA.CLS_STAT_CD IN ('ADCMPL','ATMTAD','TMPAD')
		<if test="orgId !=null and orgId !=''">  
		AND ODA.USER_ORG_ID = #{orgId}
		</if>
		AND ( OWAD.INPRSC_TM > 0 OR OWAD.TRT_CCNT > 0 )
		AND ODA.ACMP_YMD BETWEEN REPLACE(#{startYmd},'-','') AND
		REPLACE(#{startYmd},'-','')

		UNION ALL

		SELECT ODA.ACMP_YMD
		,OUWAD.TASK_NO
		,OUWAD.INPRSC_TM AS INPRSC_TM
		,OUWAD.TRT_CCNT AS TRT_CCNT
		,ODA.USER_ID
		, ODA.USER_ORG_ID
		FROM (
		SELECT ODA.ACMP_YMD
		,ODA.DDBY_ACMP_SEQ
		,ODA.USER_ID
		, ODA.USER_ORG_ID
		FROM O2_DDBY_ACMP ODA
		WHERE ODA.cls_stat_cd IN ('ADWAIT','RJCT')
		<if test="orgId !=null and orgId !=''">  
		AND ODA.USER_ORG_ID = #{orgId}
		</if>
		AND ODA.ACMP_YMD BETWEEN REPLACE(#{startYmd},'-','') AND
		REPLACE(#{startYmd},'-','')
		) ODA
		INNER JOIN O2_ACMP_ADMS_REQ OAAR
		ON ODA.DDBY_ACMP_SEQ = OAAR.DDBY_ACMP_SEQ
		INNER JOIN o2_unadms_wrk_acmp_dtl OUWAD
		ON OAAR.ADMS_REQ_SEQ = OUWAD.ADMS_REQ_SEQ
		WHERE OAAR.LAST_YN='Y'
		AND ( OUWAD.INPRSC_TM > 0 OR OUWAD.TRT_CCNT > 0 )
		) ACMP
		ON TASK.TASK_NO = ACMP.TASK_NO
			INNER JOIN
			O2_ORG ORG
			ON ORG.ORG_ID = ACMP.USER_ORG_ID
			<if test="orgId !=null and orgId !=''">  
			AND ORG.ORG_ID = #{orgId}
			</if>
		WHERE SUB.TASK_LEVEL = 1
		) A
		INNER JOIN O2_ESM_CD ESM
		ON ESM.ESM_CD = A.ESM_CD
		GROUP BY
			A.USER_NM,
			A.USER_ID,
		A.ORDER_JOB_NO,
		A.TASK_NO,
		A.SUB_TASK_SEQ DESC,
		'(T)['||ESM.ESM_NM||'] '||A.TASK_NM,
		A.ORDER_JOB_NO,
		A.TASK_LEVEL

	</select>
	
	<select id="selectOrgWrkAcmpJobByOrderList" parameterType="map" resultType="com.nhncorp.ooms.redis.deptIncome.model.DeptIncomeModel">
		/*selectOrgWrkAcmpJobByOrderList*/
		SELECT /*+ USE_IDX */
		JOB.ORDER_JOB_NO
		, '' AS TASK_NO
		, JOB.ORDER_JOB_NO AS SUB_TASK_SEQ
		, JOB.ORDER_JOB_NM AS TASK_NM
		, '' AS UPR_SUB_TASK_SEQ
		, 0 AS TASK_LEVEL
			, CASE
			WHEN OU.HR_STAT_CD = 'RTRM' AND OU.TYPE_CD_FLAG ='1' THEN
			(
			SELECT
			ORG.ORG_NM || '/' || OU.USER_NM || '(' || COMM.COMM_CD_NM || ')'
			FROM
			O2_COMM_CD COMM
			WHERE COMM.COMM_GRP_CD = 'HLOTP'
			AND COMM.USE_YN = 'Y'
			AND COMM.LANG_CD = 'ko_KR'
			AND COMM.COMM_CD = 'RTRM'
			)
			WHEN OU.HR_STAT_CD = 'RTRM' THEN
			(
			SELECT
			ORG.ORG_NM || '/' || OU.USER_NM || '(' || COMM.COMM_CD_NM || ')'
			FROM
			O2_COMM_CD COMM
			WHERE COMM.COMM_GRP_CD = 'ENCHA'
			AND COMM.USE_YN = 'Y'
			AND COMM.LANG_CD = 'ko_KR'
			AND COMM.COMM_CD = 'ENMCHANGE'
			)
			ELSE ORG.ORG_NM || '/' || OU.USER_NM
			END AS USER_NM
			,OU.USER_ID
			,CAST( SUM(DECODE( ACMP.ACMP_YMD,#{startYmd}, ACMP.INPRSC_TM, 0 )) AS
			BIGINT ) / 60 AS TM_DATA
			,SUM(DECODE( ACMP.ACMP_YMD,#{startYmd}, ACMP.TRT_CCNT, 0 )) AS CNT_DATA
			,#{startYmd} ymd
			,USER_ORG_ID
		FROM O2_ORDER_JOB JOB
		INNER JOIN (SELECT ODA.ACMP_YMD
		, TASK.ORDER_JOB_NO
		, OWAD.INPRSC_TM AS INPRSC_TM
		, OWAD.TRT_CCNT AS TRT_CCNT
		, ODA.USER_ID
		, ODA.USER_ORG_ID
		FROM O2_DDBY_ACMP ODA
		INNER JOIN O2_WRK_ACMP_DTL OWAD
		ON ODA.DDBY_ACMP_SEQ = OWAD.DDBY_ACMP_SEQ
		AND OWAD.AGRN_MTHD_TP_CD = 'CFM'
		INNER JOIN O2_TASK TASK
		ON TASK.TASK_NO = OWAD.TASK_NO
		WHERE ODA.CLS_STAT_CD IN ('ADCMPL','ATMTAD','TMPAD')
		<if test="orgId !=null and orgId !=''">  
		AND ODA.USER_ORG_ID = #{orgId}
		</if>
		AND ( OWAD.INPRSC_TM > 0 OR OWAD.TRT_CCNT > 0 )
		AND ODA.ACMP_YMD BETWEEN REPLACE(#{startYmd},'-','') AND
		REPLACE(#{startYmd},'-','')

		UNION ALL

		SELECT ODA.ACMP_YMD
		,TASK.ORDER_JOB_NO
		,OUWAD.INPRSC_TM AS INPRSC_TM
		,OUWAD.TRT_CCNT AS TRT_CCNT
		,ODA.USER_ID
		,ODA.USER_ORG_ID
		FROM (
		SELECT ODA.ACMP_YMD
		,ODA.DDBY_ACMP_SEQ
		,ODA.USER_ID
		,ODA.USER_ORG_ID
		FROM O2_DDBY_ACMP ODA
		WHERE ODA.cls_stat_cd IN ('ADWAIT','RJCT')
		<if test="orgId !=null and orgId !=''">  
		AND ODA.USER_ORG_ID = #{orgId}
		</if>
		AND ODA.ACMP_YMD BETWEEN REPLACE(#{startYmd},'-','') AND
		REPLACE(#{startYmd},'-','')
		) ODA
		INNER JOIN O2_ACMP_ADMS_REQ OAAR
		ON ODA.DDBY_ACMP_SEQ = OAAR.DDBY_ACMP_SEQ
		INNER JOIN o2_unadms_wrk_acmp_dtl OUWAD
		ON OAAR.ADMS_REQ_SEQ = OUWAD.ADMS_REQ_SEQ
		INNER JOIN O2_TASK TASK
		ON TASK.TASK_NO = OUWAD.TASK_NO
		WHERE OAAR.LAST_YN='Y'
		AND ( OUWAD.INPRSC_TM > 0 OR OUWAD.TRT_CCNT > 0 )
		) ACMP
		ON JOB.ORDER_JOB_NO = ACMP.ORDER_JOB_NO

			INNER JOIN
			O2_ORG ORG
			ON ORG.ORG_ID = ACMP.USER_ORG_ID
			INNER JOIN
			(
			SELECT /*+ USE_IDX */
			OU.USER_ID,
			OU.USER_NM,
			OU.HR_STAT_CD,
			NVL(ENT.EMP_NO,'1')AS TYPE_CD_FLAG
			FROM O2_USER OU LEFT OUTER JOIN O2_ENTERRETIRE_INFO ENT ON ENT.TYPE_CD =
			'12002'
			AND OU.USER_ID = ENT.EMP_NO
			AND ENT.USE_YN = 'Y'
			WHERE LEFT(OU.user_id,2) IN ('CM','CN','CP','GW','IN')
			<if test="orgId !=null and orgId !=''">  
			AND ORG_ID = #{orgId}
			</if>
			) OU
			ON OU.USER_ID = ACMP.USER_ID
		GROUP BY
			ORG.ORG_NM||'/'||OU.USER_NM,
			OU.USER_ID,
		JOB.ORDER_JOB_NO,
		JOB.ORDER_JOB_NM
	</select>
	
	<select id="selectNewDdbyData" resultType="com.nhncorp.ooms.redis.deptIncome.model.DeptIncomeModel">
			SELECT ACMP_YMD YMD
			,USER_ORG_ID
		FROM O2_DDBY_ACMP
		WHERE MOD_YMDT>=ADDDATE(SYSDATETIME, INTERVAL '-1' MINUTE)
		Group by ACMP_YMD,USER_ORG_ID
	</select>
	



</mapper>